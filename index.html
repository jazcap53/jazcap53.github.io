<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Making progress...</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Making progress... Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Making progress...</a></h1>
                <nav><ul>
                    <li><a href="/pages/about.html">About</a></li>
                    <li><a href="/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/but-it-looked-like-a-nail.html">But It Looked Like a Nail</a></h1>
<footer class="post-info">
        <abbr class="published" title="2020-03-30T00:00:00-04:00">
                Published: Mon 30 March 2020
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/andy-jarcho.html">Andy Jarcho</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info --><h1>Hitting pytest's capsys with a hammer</h1>
<h3>The introduction</h3>
<p>I've been trying to improve the (then 51%, as measured by pytest-cov) coverage on a script, called Caffeine Monitor, that I'm writing.</p>
<h3>The problem</h3>
<p>Caffeine Monitor keeps tabs (ahem) on the amount of caffeine in your body.</p>
<ul>
<li>
<p>If you call it with no arguments, the script gets your previous reading (level and time) from a .json file. Then it </p>
<ul>
<li>calculates your current caffeine level from that data based on a simple formula</li>
<li>writes the new level and time to stdout, and</li>
<li>overwrites the .json file with the new reading.</li>
</ul>
</li>
<li>
<p>To tell the script you just drank a cup of coffee with 240 mg of caffeine, you call it with the single argument 240.</p>
</li>
<li>
<p>If you had a cup of coffee an hour ago, but forgot to 'tell' the script, just call it with the arguments 240 60.</p>
</li>
</ul>
<p>Here's the method that overwrites the .json file, and maintains the log.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CaffeineMonitor</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">write_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iofile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>          <span class="c1"># self.iofile is the .json file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iofile</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">log_mesg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;level is {round(self.data_dict[&quot;level&quot;], 1)}&#39;</span>  <span class="c1"># level </span>
                    <span class="sa">f</span><span class="s1">&#39;at </span><span class="si">{self.data_dict[&quot;time&quot;]}</span><span class="s1">&#39;</span><span class="p">)</span>                  <span class="c1"># and time</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mg_to_add</span><span class="p">:</span> 
            <span class="n">log_mesg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{self.mg_to_add}</span><span class="s1"> mg added: &#39;</span> <span class="o">+</span> <span class="n">log_mesg</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_mesg</span><span class="p">)</span>   <span class="c1"># just had caffeine: use log level INFO</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">log_mesg</span><span class="p">)</span>  <span class="c1"># no new caffeine: log as DEBUG</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iofile</span><span class="p">)</span>
</code></pre></div>


<h3>The process</h3>
<p>I'd been struggling to test this method using pytest and pytest_mock (I'm learning about mocking and patching).
I got an object lesson in "when the only tool you have is a hammer, everything starts to look like a nail".</p>
<p>The main obstacle was capturing the log output for my tests.
I started out trying to use <code>mocker</code> to mock out the logging functionality.
Six hours later, I was <em>still</em> trying to use <code>mocker</code> to...</p>
<p>Then I ran across an <a href="https://stackoverflow.com/questions/22657591/get-all-logging-output-with-mock">SO post</a> 
that introduced me to <code>caplog</code>. The relevant part of the post was the answer by @hoefling.</p>
<p>@hoefling's pytest example:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># spam.py</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>


<span class="c1"># tests.py</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">spam</span> <span class="kn">import</span> <span class="n">foo</span>

<span class="k">def</span> <span class="nf">test_foo</span><span class="p">(</span><span class="n">caplog</span><span class="p">):</span>
    <span class="n">foo</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">caplog</span><span class="o">.</span><span class="n">records</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">record</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">caplog</span><span class="o">.</span><span class="n">records</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">record</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span>
    <span class="k">assert</span> <span class="n">record</span><span class="o">.</span><span class="n">levelno</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
    <span class="k">assert</span> <span class="n">record</span><span class="o">.</span><span class="n">module</span> <span class="o">==</span> <span class="s1">&#39;spam&#39;</span>
    <span class="c1"># etc</span>
</code></pre></div>


<p>didn't work for me initially. <code>len(caplog.records)</code> turned out to be 0 here also, until I played with the code a bit.</p>
<h3>The solution</h3>
<p>My root logger is set up as:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src/caffeine_monitor.py</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="n">current_environment</span><span class="p">][</span><span class="s1">&#39;log_file&#39;</span><span class="p">],</span>
                        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>


<p>The tests that work are: (<code>cm</code> and <code>test_files</code> are fixtures, set up in <code>conftest.py</code>, that return a <code>CaffeineMonitor</code> 
instance and a pair of file names, respectively)</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_write_file_add_mg</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">test_files</span><span class="p">,</span> <span class="n">caplog</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">test_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">l_file_handle</span><span class="p">:</span>
        <span class="n">cur_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H:%M&#39;</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mf">140.0</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">cur_time</span><span class="p">}</span>
        <span class="n">caplog</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>

        <span class="n">cm</span><span class="o">.</span><span class="n">mg_to_add</span> <span class="o">=</span> <span class="mi">140</span>

        <span class="n">cm</span><span class="o">.</span><span class="n">write_file</span><span class="p">()</span>

        <span class="k">assert</span> <span class="sa">f</span><span class="s1">&#39;140 mg added: level is 140.0 at </span><span class="si">{cur_time}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">text</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">caplog</span><span class="o">.</span><span class="n">records</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">test_write_file_add_no_mg</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">test_files</span><span class="p">,</span> <span class="n">caplog</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">test_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">l_file_handle</span><span class="p">:</span>
        <span class="n">cur_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H:%M&#39;</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mf">140.0</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">cur_time</span><span class="p">}</span>
        <span class="n">caplog</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>

        <span class="n">cm</span><span class="o">.</span><span class="n">write_file</span><span class="p">()</span>

        <span class="k">assert</span> <span class="sa">f</span><span class="s1">&#39;level is 140.0 at </span><span class="si">{cur_time}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">text</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">caplog</span><span class="o">.</span><span class="n">records</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>


<h3>The issue</h3>
<p>Log levels (sigh). I'd assumed that, since the root logger level was set to <code>DEBUG</code>, any
message of that level or higher would be sent to <code>caplog</code>. It turns out that, like the root logger, <code>caplog</code>'s 
default level is <code>WARNING</code>. Hence caplog was not seeing the messages logged by <code>CaffeineMonitor.write_file()</code>.</p>
<h3>The upshot</h3>
<p>Test coverage is at 61% and climbing.</p>
<h3>The lesson</h3>
<p>Reading documentation is something of an art form. You often can't read all the docs word-for-word; parts of it
have to be skimmed. In this case I happened to skim, and did not absorb, the datum that would have saved me hours
of work. </p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="/talk-dirty-to-me.html" rel="bookmark"
                           title="Permalink to Talk Dirty to Me">Talk Dirty to Me</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2020-03-21T00:00:00-04:00">
                Published: Sat 21 March 2020
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/andy-jarcho.html">Andy Jarcho</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->                <h1>"Hey Google: What good are you, anyway?"</h1>
<p>I'm a Pythonista who believes that 'Every Toaster Is Sacred.' Today's devices are amino acids in the primoridial ooze.</p>
<p>So I was pretty happy when I got the chance to acquire a new Google Home&#8482; at a guilt-free price.</p>
<p>For several days, it …</p>
                <a class="readmore" href="/talk-dirty-to-me.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/pomodoro.html" rel="bookmark"
                           title="Permalink to Pomodoro">Pomodoro</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2020-03-04T00:00:00-05:00">
                Published: Wed 04 March 2020
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/andy-jarcho.html">Andy Jarcho</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->                <p><img alt="" src="/images/tomato_car_even_smaller.png"></p>
<h2>Step away from the keyboard! Step AWAY from the keyboard!</h2>
<h4>The Tomato Timer</h4>
<p>Programmers, picture this: You sit down to code, hack at a problem for three hours, consume 20 ounces of black coffee, and are finally forced by the coffee to answer the call of nature.</p>
<p>You get back …</p>
                <a class="readmore" href="/pomodoro.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>